---
layout: post
title: "Nginx 1.9.0 makeï¼ˆå°ç™½å‹¿çœ‹ï¼‰"
description: ""
category: 
tags: [æŠ€æœ¯]
---


ä»Šå¤©çœ‹æœ‹å‹åœˆçœ‹åˆ°Nginxå‡ºæ¥1.9.0ï¼Œå¥½åƒå¾ˆé«˜å¤§ä¸Šçš„æ ·å­

è§‰å¾—è¿˜æ˜¯å°è¯•ç¼–è¯‘ä¸€ä¸‹ä¼šæ¯”è¾ƒå¼€å¿ƒï¼Œæ¯”è¾ƒè½¯ä»¶è¿˜æ˜¯è‡ªå·±ç¼–è¯‘çš„ç”¨çš„èˆ’å¿ƒã€‚

ä¸‹è½½è§£å‹ç•¥è¿‡ã€‚ã€‚ã€‚ã€‚

é¦–å…ˆå…ˆçœ‹ä¸€ä¸‹æœ‰å“ªäº›æ¨¡å—å§

    ./configure --help

      --help                             print this message

      --prefix=PATH                      set installation prefix
      --sbin-path=PATH                   set nginx binary pathname
      --conf-path=PATH                   set nginx.conf pathname
      --error-log-path=PATH              set error log pathname
      --pid-path=PATH                    set nginx.pid pathname
      --lock-path=PATH                   set nginx.lock pathname

      --user=USER                        set non-privileged user for
                                         worker processes
      --group=GROUP                      set non-privileged group for
                                         worker processes

      --build=NAME                       set build name
      --builddir=DIR                     set build directory

      --with-select_module               enable select module
      --without-select_module            disable select module
      --with-poll_module                 enable poll module
      --without-poll_module              disable poll module

      --with-threads                     enable thread pool support

      --with-file-aio                    enable file AIO support
      --with-ipv6                        enable IPv6 support

      --with-http_ssl_module             enable ngx_http_ssl_module
      --with-http_spdy_module            enable ngx_http_spdy_module
      --with-http_realip_module          enable ngx_http_realip_module
      --with-http_addition_module        enable ngx_http_addition_module
      --with-http_xslt_module            enable ngx_http_xslt_module
      --with-http_image_filter_module    enable ngx_http_image_filter_module
      --with-http_geoip_module           enable ngx_http_geoip_module
      --with-http_sub_module             enable ngx_http_sub_module
      --with-http_dav_module             enable ngx_http_dav_module
      --with-http_flv_module             enable ngx_http_flv_module
      --with-http_mp4_module             enable ngx_http_mp4_module
      --with-http_gunzip_module          enable ngx_http_gunzip_module
      --with-http_gzip_static_module     enable ngx_http_gzip_static_module
      --with-http_auth_request_module    enable ngx_http_auth_request_module
      --with-http_random_index_module    enable ngx_http_random_index_module
      --with-http_secure_link_module     enable ngx_http_secure_link_module
      --with-http_degradation_module     enable ngx_http_degradation_module
      --with-http_stub_status_module     enable ngx_http_stub_status_module

      --without-http_charset_module      disable ngx_http_charset_module
      --without-http_gzip_module         disable ngx_http_gzip_module
      --without-http_ssi_module          disable ngx_http_ssi_module
      --without-http_userid_module       disable ngx_http_userid_module
      --without-http_access_module       disable ngx_http_access_module
      --without-http_auth_basic_module   disable ngx_http_auth_basic_module
      --without-http_autoindex_module    disable ngx_http_autoindex_module
      --without-http_geo_module          disable ngx_http_geo_module
      --without-http_map_module          disable ngx_http_map_module
      --without-http_split_clients_module disable ngx_http_split_clients_module
      --without-http_referer_module      disable ngx_http_referer_module
      --without-http_rewrite_module      disable ngx_http_rewrite_module
      --without-http_proxy_module        disable ngx_http_proxy_module
      --without-http_fastcgi_module      disable ngx_http_fastcgi_module
      --without-http_uwsgi_module        disable ngx_http_uwsgi_module
      --without-http_scgi_module         disable ngx_http_scgi_module
      --without-http_memcached_module    disable ngx_http_memcached_module
      --without-http_limit_conn_module   disable ngx_http_limit_conn_module
      --without-http_limit_req_module    disable ngx_http_limit_req_module
      --without-http_empty_gif_module    disable ngx_http_empty_gif_module
      --without-http_browser_module      disable ngx_http_browser_module
      --without-http_upstream_hash_module
                                         disable ngx_http_upstream_hash_module
      --without-http_upstream_ip_hash_module
                                         disable ngx_http_upstream_ip_hash_module
      --without-http_upstream_least_conn_module
                                         disable ngx_http_upstream_least_conn_module
      --without-http_upstream_keepalive_module
                                         disable ngx_http_upstream_keepalive_module
      --without-http_upstream_zone_module
                                         disable ngx_http_upstream_zone_module

      --with-http_perl_module            enable ngx_http_perl_module
      --with-perl_modules_path=PATH      set Perl modules path
      --with-perl=PATH                   set perl binary pathname

      --http-log-path=PATH               set http access log pathname
      --http-client-body-temp-path=PATH  set path to store
                                         http client request body temporary files
      --http-proxy-temp-path=PATH        set path to store
                                         http proxy temporary files
      --http-fastcgi-temp-path=PATH      set path to store
                                         http fastcgi temporary files
      --http-uwsgi-temp-path=PATH        set path to store
                                         http uwsgi temporary files
      --http-scgi-temp-path=PATH         set path to store
                                         http scgi temporary files

      --without-http                     disable HTTP server
      --without-http-cache               disable HTTP cache

      --with-mail                        enable POP3/IMAP4/SMTP proxy module
      --with-mail_ssl_module             enable ngx_mail_ssl_module
      --without-mail_pop3_module         disable ngx_mail_pop3_module
      --without-mail_imap_module         disable ngx_mail_imap_module
      --without-mail_smtp_module         disable ngx_mail_smtp_module

      --with-stream                      enable TCP proxy module
      --with-stream_ssl_module           enable ngx_stream_ssl_module
      --without-stream_upstream_hash_module
                                         disable ngx_stream_upstream_hash_module
      --without-stream_upstream_least_conn_module
                                         disable ngx_stream_upstream_least_conn_module
      --without-stream_upstream_zone_module
                                         disable ngx_stream_upstream_zone_module

      --with-google_perftools_module     enable ngx_google_perftools_module
      --with-cpp_test_module             enable ngx_cpp_test_module

      --add-module=PATH                  enable an external module

      --with-cc=PATH                     set C compiler pathname
      --with-cpp=PATH                    set C preprocessor pathname
      --with-cc-opt=OPTIONS              set additional C compiler options
      --with-ld-opt=OPTIONS              set additional linker options
      --with-cpu-opt=CPU                 build for the specified CPU, valid values:
                                         pentium, pentiumpro, pentium3, pentium4,
                                         athlon, opteron, sparc32, sparc64, ppc64

      --without-pcre                     disable PCRE library usage
      --with-pcre                        force PCRE library usage
      --with-pcre=DIR                    set path to PCRE library sources
      --with-pcre-opt=OPTIONS            set additional build options for PCRE
      --with-pcre-jit                    build PCRE with JIT compilation support

      --with-md5=DIR                     set path to md5 library sources
      --with-md5-opt=OPTIONS             set additional build options for md5
      --with-md5-asm                     use md5 assembler sources

      --with-sha1=DIR                    set path to sha1 library sources
      --with-sha1-opt=OPTIONS            set additional build options for sha1
      --with-sha1-asm                    use sha1 assembler sources

      --with-zlib=DIR                    set path to zlib library sources
      --with-zlib-opt=OPTIONS            set additional build options for zlib
      --with-zlib-asm=CPU                use zlib assembler sources optimized
                                         for the specified CPU, valid values:
                                         pentium, pentiumpro

      --with-libatomic                   force libatomic_ops library usage
      --with-libatomic=DIR               set path to libatomic_ops library sources

      --with-openssl=DIR                 set path to OpenSSL library sources
      --with-openssl-opt=OPTIONS         set additional build options for OpenSSL

      --with-debug                       enable debug logging

ä»¥ä¸Šéœ€è¦è§£é‡Šä¹ˆï¼Ÿï¼Ÿï¼Ÿ

ç®—äº†ï¼Œä¸ç»™å°ç™½çœ‹çš„ã€‚ã€‚ã€‚

## PCRE

    sudo apt-get install libpcre3 libpcre3-dev
    
OR

Download here <ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/>

    cd /tmp/
    wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.37.tar.gz
    tar xzf pcre*.tar.gz
    
## GeoIPè¿™éƒ¨åˆ†è¯·å‚è€ƒé“¾æ¥
<http://www.vpsee.com/2011/03/install-nginx-with-geoip-module-for-country-targeting/>  http_geoip_module

ç®—äº†ï¼Œè´´ä¸€ä¸‹å§ã€‚ã€‚ã€‚

å¦‚æœæƒ³å±è”½æŸä¸ªåœ°åŒºçš„ IP è®¿é—®çš„è¯ï¼Œç”¨ iptables æŠŠæ¥è‡ªæŸä¸ªå›½å®¶çš„ IP é‡å®šå‘åˆ°é¢„å®šé¡µé¢ä¸æ˜¯ç‰¹åˆ«çµæ´»çš„åŠæ³•ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ª IP å¯ç”¨è€Œæœ‰å¤šä¸ªç½‘ç«™åœ¨åŒä¸€ VPS ä¸Šæ€ä¹ˆåŠï¼Ÿç”¨ iptable å±è”½æŸä¸ªç½‘ç«™çš„è¯ä¹Ÿä¼šå±è”½åŒä¸€ VPS ä¸Šçš„å…¶ä»–ç½‘ç«™çš„è®¿é—®ã€‚æ‰€ä»¥æ­£ç»Ÿçš„åŠæ³•è¿˜æ˜¯ç”¨ GeoIP é…åˆå¯¹åº”çš„ web æœåŠ¡å™¨æ¨¡å—ï¼Œæ¯”å¦‚ï¼šapache + mod_geoip æˆ–è€… nginx + http_geoip_module ç­‰ã€‚

MaxMind æä¾›äº†å…è´¹çš„ IP åœ°åŸŸæ•°æ®åº“ï¼ˆGeoIP.datï¼‰ï¼Œä¸è¿‡è¿™ä¸ªæ•°æ®åº“æ–‡ä»¶æ˜¯äºŒè¿›åˆ¶çš„ï¼Œéœ€è¦ç”¨ GeoIP åº“æ¥è¯»å–ï¼Œæ‰€ä»¥é™¤äº†è¦ä¸‹è½½ GeoIP.dat æ–‡ä»¶å¤–ï¼ˆè§ä¸‹ä¸€æ­¥ï¼‰ï¼Œè¿˜éœ€è¦å®‰è£…èƒ½è¯»å–è¿™ä¸ªæ–‡ä»¶çš„åº“ã€‚

    cd /tmp/
    wget http://geolite.maxmind.com/download/geoip/api/c/GeoIP.tar.gz
    tar -zxvf GeoIP.tar.gz
    cd GeoIP-*
    ./configure
    make && sudo make install
    
åˆšæ‰å®‰è£…çš„åº“è‡ªåŠ¨å®‰è£…åˆ° /usr/local/lib ä¸‹ï¼Œæ‰€ä»¥è¿™ä¸ªç›®å½•éœ€è¦åŠ åˆ°åŠ¨æ€é“¾æ¥é…ç½®é‡Œé¢ä»¥ä¾¿è¿è¡Œç›¸å…³ç¨‹åºçš„æ—¶å€™èƒ½è‡ªåŠ¨ç»‘å®šåˆ°è¿™ä¸ª GeoIP åº“ï¼š

    echo '/usr/local/lib' | sudo tee -a /etc/ld.so.conf.d/geoip.conf
    sudo ldconfig

### ä¸‹è½½ IP æ•°æ®åº“
MaxMind æä¾›äº†å…è´¹çš„ IP åœ°åŸŸæ•°æ®åº“ï¼Œè¿™ä¸ªæ•°æ®åº“æ˜¯äºŒè¿›åˆ¶çš„ï¼Œä¸èƒ½ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ï¼Œéœ€è¦ä¸Šé¢çš„ GeoIP åº“æ¥è¯»å–ï¼š

    wget http://geolite.maxmind.com/download/geoip/database/GeoLiteCountry/GeoIP.dat.gz
    gunzip GeoIP.dat.gz

ç¼–è¯‘å®Œnginxé…ç½®ï¼Œåœ¨ç›¸å…³åœ°æ–¹åŠ ä¸Šå¦‚ä¸‹çš„é…ç½®å°±å¯ä»¥äº†ï¼š

    # vim /etc/nginx/nginx.conf

    http {
    ...
    geoip_country /home/vpsee/GeoIP.dat;
    fastcgi_param GEOIP_COUNTRY_CODE $geoip_country_code;
    fastcgi_param GEOIP_COUNTRY_CODE3 $geoip_country_code3;
    fastcgi_param GEOIP_COUNTRY_NAME $geoip_country_name;
    ...
    }

    server {
    ...
            location / {
                root   /home/vpsee/www;
                if ($geoip_country_code = CN) {
                    root /home/vpsee/cn;
                }
                ...
            }
    ...
    }

è¿™æ ·ï¼Œå½“æ¥è‡ªä¸­å›½çš„ IP è®¿é—®ç½‘ç«™åå°±è‡ªåŠ¨è®¿é—®åˆ°é¢„å®šçš„ /home/vpsee/cn é¡µé¢ã€‚å…³äº Nginx + GeoIP è¿˜æœ‰å¾ˆå¤šæœ‰ç”¨çš„ç”¨æ³•ï¼Œæ¯”å¦‚åšä¸ªç®€å•çš„ CDNï¼Œæ¥è‡ªä¸­å›½çš„è®¿é—®è‡ªåŠ¨è§£æåˆ°å›½å†…æœåŠ¡å™¨ã€æ¥è‡ªç¾å›½çš„è®¿é—®è‡ªåŠ¨è½¬å‘åˆ°ç¾å›½æœåŠ¡å™¨ç­‰ã€‚MaxMind è¿˜æä¾›äº†å…¨çƒå„ä¸ªåŸå¸‚çš„ IP ä¿¡æ¯ï¼Œè¿˜å¯ä»¥ä¸‹è½½åŸå¸‚ IP æ•°æ®åº“æ¥é’ˆå¯¹ä¸åŒåŸå¸‚åšå¤„ç†ã€‚
    
## google perftools module

    cd /tmp/
    wget http://gperftools.googlecode.com/files/gperftools-2.1.tar.gz
    tar xzf gperftools*.tar.gz
    cd gperftools*
    ./configure --prefix=/usr --enable-frame-pointers   # æˆ‘æ˜¯64ä½çš„ï¼Œenable-frame-pointersè¦åŠ ä¸ª
    make
    sudo make install
    echo "/usr/local/lib" |sudo tee -a /etc/ld.so.conf.d/usr_local_lib.conf
    sudo /sbin/ldconfig
    
å†—é•¿çš„config
    
    ./configure --prefix=/usr/local/nginx \
    --sbin-path=/usr/local/nginx/sbin/nginx \
    --conf-path=/usr/local/nginx/conf/ \
    --error-log-path=/usr/local/nginx/logs/ \
    --http-log-path=/usr/local/nginx/logs/ \
    --pid-path=/usr/local/nginx/logs/ \
    --lock-path=/usr/local/nginx/logs/ \
    --user=nginx --group=nginx \
    --build=nginx-lz \
    --builddir=./nginx-lz \
    --with-file-aio \
    --with-ipv6 \
    --with-http_ssl_module \
    --with-http_realip_module \
    --with-http_addition_module \
    --with-http_geoip_module \
    --with-http_sub_module \
    --with-http_dav_module \
    --with-http_mp4_module \
    --with-http_gunzip_module \
    --with-http_gzip_static_module \
    --with-http_auth_request_module \
    --with-http_secure_link_module \
    --with-http_degradation_module \
    --with-http_stub_status_module \
    --with-stream \
    --with-stream_ssl_module \
    --with-google_perftools_module \
    --with-pcre \
    --with-perl_modules_path=/tmp/pcre* \
    --with-pcre-jit \
    --with-debug

æ•´å®Œå°±å¯ä»¥makeå’Œmake installäº†



å‚è€ƒï¼š

- <http://admclub.com/view/ä½¿ç”¨google-perftoolsä¼˜åŒ–nginxåœ¨é«˜å¹¶å‘æ—¶çš„æ€§èƒ½>
- <http://www.vpsee.com/2011/03/install-nginx-with-geoip-module-for-country-targeting/>  http_geoip_module
- <http://www.xxorg.com/archives/749> http_sub_module